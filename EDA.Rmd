---
title: "679 Final Project"
author: "Team 9"
date: "4/12/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(plyr)
library(reshape2)
library(tidyr)
library(viridis)
library(psych)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
DF <- read.csv("transformed.csv", encoding="UTF-8")
describe(DF)
```

```{r}
colnames(DF) <- c("Study.ID","Sex",                                    "Year.of.Diagnosis","Age.at.Diagnosis","Race",                                       "Insurance","SEER.Registry","X...9th.Grade.Education",                         "X...High.School.Education","X...Bachelors.Education",                         "X..Persons.Below.Poverty","X..Unemployed.ACS.2013.2017",                     "Median.Household.Income",                      "X..Language.isolation.ACS.2013.2017..households.","Site",                              "Subsite","AJCC.7.Stage","Size",                                            "Lymph.Nodes","Mets","Cause.of.Death",                                  "Surgery.Performed.","Surgery.Decision","Radiation",                                    "Chemotherapy")
colnames(DF)
```

# Exploratory Data Analysis

  There are seven kinds of cancer with different stages in this dataset. To simplify our research, we decide to choose only one kind of cancer to do the analysis. So, we firstly explore the top 10 cancers(including the stages) that the patients are most likely to give up the surgery. Giving up the surgery can more suggest that the patients are affected by some factors such as biases in the society.

```{r message=FALSE}
df_cancer_stage <- DF %>% 
  dplyr::select(Site,AJCC.7.Stage,Surgery.Decision,Study.ID) %>% 
  unite("Cancer_Stage",Site,AJCC.7.Stage,sep = "-") %>% 
  dplyr::group_by(Cancer_Stage,Surgery.Decision) %>% 
  dplyr::summarise(num = n()) %>% ungroup() %>% 
  dplyr::arrange(desc(num))
```

```{r}
df_cancer_stage$Surgery.Decision <- revalue(df_cancer_stage$Surgery.Decision, 
c("Recommended, unknown if performed"= "Recommended",
  
"Recommended but not performed, patient refused"= "Recom & refused",

"Recommended but not performed, unknown reason"= "Recom & not performed",

"Not recommended, contraindicated due to other cond; autopsy only (1973-2002)"= "Not recom & contraindicated",

"Not performed, patient died prior to recommended surgery"= "Not performed & died",

"Unknown; death certificate; or autopsy only (2003+)"= "Unknown"))
```

  The plot below shows that, even given recommendation, some patients with oral cavity cancer in nearly all the stages, even the early stage, have given up the surgery. So we choose oral cavity cancer as our research direction.

```{r}
# Top 10 Giving-Up-Surgery Cancer
df_cancer_stage %>% 
  dplyr::filter(Surgery.Decision %in% c("Recommended","Recom & refused","Recom & not performed")) %>% 
  mutate(percent = num/sum(num)) %>% 
  mutate(Cancer_Stage = reorder(Cancer_Stage,percent)) %>% 
  top_n(10,wt = percent) %>% 
  ggplot() + 
  geom_bar(aes(x = Cancer_Stage,y = percent, fill = Surgery.Decision),stat = "identity") + 
  labs(title = "Top 10 Cancers that are Most Likely to Giving Up Surgery", 
       x = "Cancer with Stage",y = "Percentage",
       fill = "Surgery Decision") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  scale_fill_manual(values = c("orange", "royalblue","limegreen"))+
  coord_flip()
```


```{r eval=FALSE}
df_oral <- DF %>% dplyr::filter(Site == "Oral Cavity")
```

## Features vs `Surgery Performed` 

  To begin with, we would like to take a look at the condition of surgery implementation.

**State**

### Environment Attributes by State

  Household Income, Poverty, Unemployment, Language Isolation and Education are all recorded on county level, which can also be regarded as important attributes of the respondents' `SEER.Registry`, so we would like to explore their distribution by states.
  
  For Poverty, the state of Georgia has the highest poverty rate, over 15% in average. For Unemployment, the unemployment rates are quite similar across those 4 states. For Household Income, the state of Georgia has the lowest household income in average. For Language Isolation, the state of Alaska has the lowest language isolation rate, while the state of California has the highest.
  

```{r message=FALSE}
g1 <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Ave = mean(X..Persons.Below.Poverty)) %>% 
  ggplot() +
  geom_bar(aes(x = SEER.Registry, y = Ave), stat = "identity") +
  labs(title = "Below Poverty Percentage vs State", x = "State", y = "Below Poverty Percentage")

g2 <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Ave = mean(X..Unemployed.ACS.2013.2017)) %>% 
  ggplot() +
  geom_bar(aes(x = SEER.Registry, y = Ave), stat = "identity") +
  labs(title = "Unemployed Percentage vs State", x = "State", y = "Unemployed Percentage")

g3 <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Ave = mean(Median.Household.Income)) %>% 
  ggplot() +
  geom_bar(aes(x = SEER.Registry, y = Ave), stat = "identity") +
  labs(title = "Median Household Income vs State", x = "State", y = "Median Household Income")

g4 <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Ave = mean(X..Language.isolation.ACS.2013.2017..households.)) %>% 
  ggplot() +
  geom_bar(aes(x = SEER.Registry, y = Ave), stat = "identity") +
  labs(title = "Language Isolation Percentage vs State", x = "State", y = "Language Isolation Percentage")
```

```{r}
gridExtra::grid.arrange(g1, g2, g3, g4, nrow = 2)
```

```{r message=FALSE}
edu_9 <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Avg = mean(X...9th.Grade.Education))
edu_h <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Avg = mean(X...High.School.Education))
edu_b <- df_oral %>% dplyr::group_by(SEER.Registry) %>% dplyr::summarise(Avg = mean(X...Bachelors.Education))
edu_9$Avg1 <- edu_h$Avg
edu_9$Avg2 <- edu_b$Avg

df_int <- stack(edu_9[,2:4])
df_state_edu <- data.frame(rep(c("Alaska", "California", "Connecticut", "Georgia"), 3), df_int)
colnames(df_state_edu) <- c("State", "values", "education")

state <- c(rep("Alaska", 3), rep("California", 3), rep("Connecticut", 3), rep("Georgia", 3))
edu <- rep(c("9th Grade", "High School", "Bachelor"), 4)
values <- c(df_state_edu$values[1], df_state_edu$values[5], df_state_edu$values[9], df_state_edu$values[2], df_state_edu$values[6], df_state_edu$values[10], df_state_edu$values[3], df_state_edu$values[7], df_state_edu$values[11], df_state_edu$values[4], df_state_edu$values[8], df$values[12])
```

  For Education, the state of California has the highest proportion of respondents are educated below 9th Grade and the highest proportion of repondents are educated below High School. Meanwhile, the state of Connecticut has the highest proportion of respondents are educated below Bechelor.
  
```{r message=FALSE}
df_state_edu2 <- data.frame(state, edu, values)
df_state_edu2 %>% 
  ggplot(aes(fill = edu, x = state, y = values/100)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Education Status per State", x = "State", y = "Percentage", fill = "Education") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
  
```

  By examining surgery implementation condition by state, we found that California has the largest population of patients researched in the data. While Alaska and Connecticut have the largest proportion of patients who have performed the surgery.
  
```{r message=FALSE}
# Registry State vs. Whether the surgery implemented
p1 <- ggplot(df_oral, aes(x = SEER.Registry, fill = Surgery.Performed.) ) +  
    geom_bar( aes(y = ..count../sum(..count..) ) ) +
    labs(title = "Surgery Implementation by State",
         x = "Registered State",
         y = "Percentage") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred") ) 

p2 <- df_oral %>% select(SEER.Registry, Study.ID, Surgery.Performed.) %>% 
  dplyr::group_by(SEER.Registry, Surgery.Performed.) %>% 
  dplyr::summarise(num = n()) %>% 
  ungroup() %>% 
  dplyr::mutate(percent = num/sum(num)) %>% 
  
  ggplot()+
  geom_bar(aes(x = SEER.Registry, y = percent, fill = Surgery.Performed.), position = "fill", stat = "identity") + 
  labs(
         x = "Registered State",
         y = "Percentage") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred") )

gridExtra::grid.arrange(p1,p2)
```

**Race & Gender**

  Before looking at the surgery condition by race and gender, we would like to take a look at the distribution of race by gender. The plot above shows that, more than 60% of observations are white people, and more than 40% of observations are white male, which indicates that there would be an imbalance problem in the data.
    
```{r message=FALSE, warning=FALSE}
# Distribution of race by gender
df_oral %>% select(Race,Sex,Study.ID) %>% 
    dplyr::group_by(Race,Sex) %>% 
    dplyr::summarise(num = n()) %>% 
    ungroup() %>% 
    dplyr::mutate(percent = num/sum(num)) %>% 
    
    ggplot() +
    geom_bar(aes(x = Race,y = percent,fill = Sex),stat = "identity") +
    labs(title = "Distribution of Race by Gender",x = "Race", y = "Percentage") + 
    scale_fill_manual("Gender", values = c("pink", "skyblue"))+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme(axis.text.x = element_text(angle = 10, hjust = 0.5, vjust = 0.5))
```
    
  For surgery condition, the plot below shows that Asian of Pacific Islander has the largest proportion of performing the surgery while the Black has the smallest one. Female and Male has almost the same proportion to accept the surgery, which seems that there is no gender biases.
    
```{r message=FALSE}
# Race vs. Whether the surgery implemented

p3 <- df_oral %>% select(Race, Study.ID, Surgery.Performed.) %>% 
  dplyr::group_by(Race, Surgery.Performed.) %>% 
  dplyr::summarise(num = n()) %>% 
  ungroup() %>% 
  dplyr::mutate(percent = num/sum(num)) %>% 
  
  ggplot()+
  geom_bar(aes(x = Race, y = percent, fill = Surgery.Performed.), position = "fill", stat = "identity") + 
  labs(title = "Surgery Implementation by Race & Gender",
         x = "Race",
         y = "Percentage") +
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme(axis.text.x = element_text(angle = 10, hjust = 0.5, vjust = 0.5)) + 
    guides(fill = F)

# Gender vs. Whether the surgery implemented

p4 <- df_oral %>% select(Sex, Study.ID, Surgery.Performed.) %>% 
  dplyr::group_by(Sex, Surgery.Performed.) %>% 
  dplyr::summarise(num = n()) %>% 
  ungroup() %>% 
  dplyr::mutate(percent = num/sum(num)) %>% 
  
  ggplot()+
  geom_bar(aes(x = Sex, y = percent, fill = Surgery.Performed.), position = "fill", stat = "identity") + 
  labs(
         x = "Gender",
         y = "Percentage") +
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

```{r}
gridExtra::grid.arrange(p3,p4)
```

  After looking at distribution by gender and race separately, we would like to put these 2 factors together to explore the distribution of performed surgery.
  
  Then, we find that the white male has the largest proportion of performing a surgery. 
    
```{r}
# Gender cross Race  vs.  Whether the surgery implemented
df2 <- df_oral[,c("Sex","Race", "Surgery.Performed.")] 
df2$Sex <- revalue(df2$Sex, c("Female"="F"))
df2$Sex <- revalue(df2$Sex,c("Male"="M"))
df2$Race <- revalue(df2$Race,c("Asian or Pacific Islander"="Asian/PI"))
df2$Race <- revalue(df2$Race,c("American Indian/Alaska Native"="Indigen"))
df2 <-  unite(df2, "Sex_Race", Sex, Race, sep = "_", remove = FALSE)
```


```{r}
ggplot(df2, aes(x = Sex_Race, fill = Surgery.Performed.) ) +  
    geom_bar( aes(y = ..count../sum(..count..) ) ) +
    labs(title = "Surgery Implementation by Gender_Race",
         x = "Gender_Race",
         y = "Percentage")+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred")) + coord_flip()
```

**Insurance**

  Besides of the demographic features, we also concern about the impact of social biases like insurance on whether to perform the surgery or not. From below chart, we can see that the large majority of repondents are insured and insured people are most likely to perform the surgery.

```{r message=FALSE, warning=FALSE}
p5 <- df_oral %>% select(Insurance,Surgery.Performed.,Study.ID) %>% 
    dplyr::group_by(Insurance,Surgery.Performed.) %>% 
    dplyr::summarise(num = n()) %>% 
    ungroup() %>% 
    mutate(percent = num/sum(num)) %>% 
    ggplot() +
    geom_bar(aes(x = Insurance,y = percent,fill = Surgery.Performed.),stat = "identity") +
    labs(title = "Surgery Implementation by Insurance Type",x = NULL, y = "Percentage") + 
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred")) + coord_flip()

p6 <- df_oral %>% select(Insurance,Surgery.Performed.,Study.ID) %>% 
    dplyr::group_by(Insurance,Surgery.Performed.) %>% 
    dplyr::summarise(num = n()) %>% 
    ungroup() %>% 
    mutate(percent = num/sum(num)) %>% 
    ggplot() +
    geom_bar(aes(x = Insurance,y = percent,fill = Surgery.Performed.), position = "fill", stat = "identity") +
    labs(x = NULL, y = "Percentage") + 
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    scale_fill_manual("Surgery Implementation", values = c("grey55", "darkred")) + coord_flip()

```

```{r}
gridExtra::grid.arrange(p5,p6)
```

## Trend

  After exploring the relationship between all kinds of features and the surgery implementation situation, we want to research the change of surgery implementation on time series.
  
  From the below plot, for the trend of amount of performed surgery, we can see that as time goes by, there is an upper trend. 
    
```{r message=FALSE, warning=FALSE}
df_oral %>% 
    select(Year.of.Diagnosis,Surgery.Performed.,Study.ID) %>% 
    mutate(Year.of.Diagnosis = as.character(Year.of.Diagnosis)) %>% 
    dplyr::group_by(Year.of.Diagnosis,Surgery.Performed.) %>% 
    dplyr::summarise(num = n()) %>% ungroup() %>% 
    ggplot() + 
    geom_line(aes(x = Year.of.Diagnosis,
                  y = num,
                  group = Surgery.Performed.,
                  col = Surgery.Performed.),size = 1) +
    labs(title = "Performed Surgery Trend by Year",
         x = "Year of Dignosis",y = "Count") +
    scale_color_manual("Surgery Implementation",values = c("grey55", "darkred"))
```

```{r message=FALSE, warning=FALSE}
ggplot(data=df_oral, aes(x=Age.at.Diagnosis, group=Surgery.Performed., fill=Surgery.Performed.)) +
    geom_density(adjust=1.5, alpha=.4) + 
  labs(title = "Surgery Performed Status by Age",
       x = "Age at Diagnosis",y = "Density",
       fill = "Surgery Performed")
```

```{r message=FALSE, warning=FALSE}
ggplot(data=df_oral, aes(x=Size, group=Surgery.Performed., fill=Surgery.Performed.)) +
    geom_density(adjust=1.5, alpha=.4) + 
  labs(title = "Surgery Performed Status by Tumor Size",
       x = "Tumor Size (mm)",y = "Density",
       fill = "Surgery Performed")
```





